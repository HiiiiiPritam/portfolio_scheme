<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSCC Chatbot Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <div class="logo-circle">
                <img src="assets/shibu.png" alt="Jharkhand Logo">
            </div>
            <div class="header-title">
                <h1>GSCC Chatbot</h1>
                <p id="headerStatus">Guruji Student Credit Card</p>
            </div>
        </div>
        <div class="header-right">
            <div class="shibu-circle">
                <img src="assets/jhklogo.png" alt="Shibu">
            </div>
        </div>
    </div>

    <!-- Body -->
    <div class="chat-body">
        <!-- Language Selection - COMMENTED OUT FOR ENGLISH ONLY -->
        <!--
        <div class="language-selection" id="languageSelection">
            <div class="language-icon">
                <svg viewBox="0 0 24 24">
                    <path d="m5 8 6 6"></path>
                    <path d="m4 14 6-6 2-3"></path>
                    <path d="M2 5h12"></path>
                    <path d="M7 2h1"></path>
                    <path d="m22 22-5-10-5 10"></path>
                    <path d="M14 18h6"></path>
                </svg>
            </div>
            <h3>Select Your Language / भाषा चुनें</h3>
            <p>Choose your preferred language to continue<br/><br/>जारी रखने के लिए अपनी पसंदीदा भाषा चुनें</p>
            <div class="language-buttons">
                <button class="language-btn" onclick="selectLanguage('english')">English</button>
                <button class="language-btn" onclick="selectLanguage('hindi')">हिंदी</button>
            </div>
        </div>
        -->

        <!-- Chat Messages -->
        <div class="chat-messages active" id="chatMessages">
            <!-- Language Toggle - COMMENTED OUT -->
            <!--
            <div class="language-toggle">
                <button class="toggle-btn" onclick="changeLanguage()">
                    <svg viewBox="0 0 24 24">
                        <path d="m5 8 6 6"></path>
                        <path d="m4 14 6-6 2-3"></path>
                        <path d="M2 5h12"></path>
                        <path d="M7 2h1"></path>
                        <path d="m22 22-5-10-5 10"></path>
                        <path d="M14 18h6"></path>
                    </svg>
                    <span id="toggleBtnText">Change Language</span>
                </button>
            </div>
            -->
            <div class="messages-container" id="messagesContainer"></div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-bubble">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input-area active" id="chatInputArea">
        <div class="input-container">
            <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Ask about GSCC scheme..."
            >
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    // API Configuration
    const API_BASE = (() => {
        if (typeof window !== 'undefined' && window.API_BASE) return window.API_BASE;
        if (location.hostname === '127.0.0.1') {
            return 'http://localhost:5500';
        }
        return '';
    })();

    function getOrCreateSessionId() {
        const STORAGE_KEY = 'gscc_session_id';
        try {
            const existing = localStorage.getItem(STORAGE_KEY);
            if (existing) return existing;
            const random = (window.crypto && window.crypto.randomUUID)
                ? window.crypto.randomUUID()
                : `${Date.now()}-${Math.random().toString(16).slice(2)}`;
            const sessionId = `web-${random}`;
            localStorage.setItem(STORAGE_KEY, sessionId);
            return sessionId;
        } catch (_) {
            return `web-fallback-${Date.now()}-${Math.random().toString(16).slice(2)}`;
        }
    }

    // State - ENGLISH ONLY MODE
    let currentLanguage = 'english'; // Always English
    let isTyping = false;

    // Translations - HINDI COMMENTED OUT
    const translations = {
        english: {
            welcome: "Welcome to the Jharkhand Guruji Student Credit Card (GSCC) Assistant.\n\nI am an AI assistant trained on official government documentation to help students and parents understand the Student Credit Card scheme.\n\nI can help you with:\n• Eligibility criteria for the credit card\n• Maximum loan limits and interest rates\n• List of approved banks and institutions\n• Mandatory document requirements\n• Application process and tracking\n• Repayment terms and moratorium periods\n\nPlease ask any questions regarding the GSCC Jharkhand scheme.",
            changeLanguage: "Change Language",
            placeholder: "Ask about GSCC scheme...",
            typing: "Thinking...",
            status: "Online"
        }
        /*
        hindi: {
            welcome: "झारखंड गुरुजी छात्र क्रेडिट कार्ड (GSCC) सहायक में आपका स्वागत है।\n\nमैं छात्रों और माता-पिता को छात्र क्रेडिट कार्ड योजना को समझने में मदद करने के लिए आधिकारिक सरकारी दस्तावेज़ीकरण पर प्रशिक्षित एक AI सहायक हूं।\n\nमैं आपकी इनमें सहायता कर सकता हूं:\n• क्रेडिट कार्ड के लिए पात्रता मानदंड\n• अधिकतम ऋण सीमा और ब्याज दरें\n• अनुमोदित बैंकों और संस्थानों की सूची\n• अनिवार्य दस्तावेज़ आवश्यकताएं\n• आवेदन प्रक्रिया और ट्रैकिंग\n• पुनर्भुगतान शर्तें और स्थगन अवधि\n\nकृपया GSCC झारखंड योजना के बारे में कोई भी प्रश्न पूछें।",
            changeLanguage: "भाषा बदलें",
            placeholder: "GSCC योजना के बारे में पूछें...",
            typing: "सहायक टाइप कर रहा है...",
            status: "ऑनलाइन"
        }
        */
    };

    // DOM Elements
    // const languageSelection = document.getElementById('languageSelection'); // Not needed
    const chatMessages = document.getElementById('chatMessages');
    const chatInputArea = document.getElementById('chatInputArea');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const headerStatus = document.getElementById('headerStatus');
    // const toggleBtnText = document.getElementById('toggleBtnText'); // Not needed

    // Auto-start in English mode
    window.addEventListener('DOMContentLoaded', () => {
        // Add welcome message immediately
        addMessage('bot', translations.english.welcome);
    });

    // Language Selection - COMMENTED OUT
    /*
    function selectLanguage(lang) {
        currentLanguage = lang;
        languageSelection.classList.add('hidden');
        chatMessages.classList.add('active');
        chatInputArea.classList.add('active');

        // Update UI text
        toggleBtnText.textContent = translations[lang].changeLanguage;
        chatInput.placeholder = translations[lang].placeholder;

        // Add welcome message
        addMessage('bot', translations[lang].welcome);
    }
    */

    // Change Language - COMMENTED OUT
    /*
    function changeLanguage() {
        currentLanguage = null;
        languageSelection.classList.remove('hidden');
        chatMessages.classList.remove('active');
        chatInputArea.classList.remove('active');
        messagesContainer.innerHTML = '';
    }
    */

    // Format response text
    function formatResponse(text) {
        text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        let lines = text.split('\n');
        let inList = false;
        let inNumberedList = false;
        let formattedLines = [];

        for (let line of lines) {
            let trimmedLine = line.trim();

            // Handle numbered lists (1., 2., etc.)
            if (trimmedLine.match(/^\d+\.\s/)) {
                if (!inNumberedList) {
                    if (inList) {
                        formattedLines.push('</ul>');
                        inList = false;
                    }
                    formattedLines.push('<ol>');
                    inNumberedList = true;
                }
                let content = trimmedLine.replace(/^\d+\.\s*/, '');
                content = content.replace(/^\*\s*/, '');
                formattedLines.push('<li>' + content + '</li>');
            }
            // Handle bullet points (• or *)
            else if (trimmedLine.match(/^[•\*]\s/)) {
                if (!inList) {
                    if (inNumberedList) {
                        formattedLines.push('</ol>');
                        inNumberedList = false;
                    }
                    formattedLines.push('<ul>');
                    inList = true;
                }
                let content = trimmedLine.replace(/^[•\*]\s*/, '');
                formattedLines.push('<li>' + content + '</li>');
            }
            // Handle nested items with asterisks
            else if (trimmedLine.match(/^\s+\*\s/)) {
                let content = trimmedLine.replace(/^\s+\*\s*/, '');
                formattedLines.push('<div class="nested-item">' + content + '</div>');
            }
            else {
                if (inList) {
                    formattedLines.push('</ul>');
                    inList = false;
                }
                if (inNumberedList) {
                    formattedLines.push('</ol>');
                    inNumberedList = false;
                }
                if (trimmedLine) {
                    formattedLines.push('<p>' + line + '</p>');
                }
            }
        }

        if (inList) formattedLines.push('</ul>');
        if (inNumberedList) formattedLines.push('</ol>');

        return formattedLines.join('\n').replace(/<p>\s*<\/p>/g, '');
    }

    // Add Message
    function addMessage(sender, content, isHtml = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        // Add AI avatar for bot messages
        if (sender === 'bot') {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'bot-avatar';
            const avatarImg = document.createElement('img');
            avatarImg.src = 'assets/chatbot.jpeg';
            avatarImg.alt = 'AI Assistant';
            avatarDiv.appendChild(avatarImg);
            messageDiv.appendChild(avatarDiv);
        }

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';

        if (isHtml) {
            bubbleDiv.innerHTML = content;
        } else {
            bubbleDiv.innerHTML = formatResponse(content);
        }

        messageDiv.appendChild(bubbleDiv);
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Send Message with Streaming
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || isTyping) return;

        // Add user message
        addMessage('user', message);
        chatInput.value = '';
        updateSendButton();

        // Show typing indicator
        isTyping = true;
        typingIndicator.classList.add('active');

        // Create bot message container for streaming
        const botDiv = document.createElement('div');
        botDiv.className = 'message bot';

        // Add AI avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'bot-avatar';
        const avatarImg = document.createElement('img');
        avatarImg.src = 'assets/chatbot.jpeg';
        avatarImg.alt = 'AI Assistant';
        avatarDiv.appendChild(avatarImg);
        botDiv.appendChild(avatarDiv);

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        botDiv.appendChild(bubbleDiv);

        let fullResponse = '';
        let messageAdded = false;

        try {
            const sessionId = getOrCreateSessionId();
            const response = await fetch(`${API_BASE}/chat-stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-id': sessionId,
                },
                body: JSON.stringify({
                    question: message,
                    sessionId,
                    language: currentLanguage // Always 'english'
                })
            });

            if (!response.ok) {
                let errorPayload = {};
                try {
                    errorPayload = await response.json();
                } catch (_) {}
                throw new Error(errorPayload.error || `Request failed with status ${response.status}`);
            }

            if (!response.body) {
                throw new Error('Streaming not supported in this browser');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const parts = buffer.split('\n\n');
                buffer = parts.pop() || '';

                for (const part of parts) {
                    if (!part.trim()) continue;
                    const lines = part.split('\n').filter(Boolean);
                    const eventLine = lines.find((line) => line.startsWith('event:'));
                    const dataLines = lines.filter((line) => line.startsWith('data:'));
                    if (!eventLine || dataLines.length === 0) continue;

                    const event = eventLine.replace('event:', '').trim();
                    let payload = null;
                    try {
                        payload = JSON.parse(
                            dataLines.map((line) => line.replace('data:', '').trim()).join('\n')
                        );
                    } catch (_) {
                        continue;
                    }

                    if (event === 'chunk') {
                        if (!messageAdded) {
                            typingIndicator.classList.remove('active');
                            messagesContainer.appendChild(botDiv);
                            messageAdded = true;
                        }

                        fullResponse += payload?.text || '';
                        bubbleDiv.innerHTML = formatResponse(fullResponse);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else if (event === 'end') {
                        await reader.cancel().catch(() => {});
                        break;
                    } else if (event === 'error') {
                        await reader.cancel().catch(() => {});
                        throw new Error(payload?.error || 'Streaming error');
                    }
                }
            }
        } catch (error) {
            console.error('Error sending message:', error);

            typingIndicator.classList.remove('active');

            if (!messageAdded) {
                messagesContainer.appendChild(botDiv);
            }

            bubbleDiv.innerHTML = formatResponse(
                `Sorry, I encountered an error: ${error.message}`
            );
        } finally {
            typingIndicator.classList.remove('active');
            isTyping = false;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // Update Send Button State
    function updateSendButton() {
        if (chatInput.value.trim()) {
            sendBtn.classList.add('active');
        } else {
            sendBtn.classList.remove('active');
        }
    }

    // Input Event Listeners
    chatInput.addEventListener('input', updateSendButton);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</body>
</html>